<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # 1. FIX for ERR_CONNECTION_RESET / HTTP2 Errors
    # Prevents server from mishandling JS/CSS compression
    <FilesMatch "\.(js|css)$">
        Header unset ETag
        FileETag None
    </FilesMatch>

    # 2. Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # 3. CORS Headers
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "POST, GET, OPTIONS, DELETE, PUT"
    Header always set Access-Control-Max-Age "1000"
    Header always set Access-Control-Allow-Headers "x-requested-with, Content-Type, origin, authorization, accept, client-security-token"

    # 4. Handle OPTIONS requests (for CORS preflight)
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]

    # 5. Send ALL non-file Requests To Laravel (index.php)
    # IMPORTANT: We route to index.php (Laravel), NOT index.html.
    # Laravel's route "/" will serve the View that contains the React App.
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
</IfModule>
